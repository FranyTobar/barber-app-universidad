<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Cita - BarberApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            display: block;
            border-radius: 5px;
            margin: 5px 0;
        }
        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar a.active {
            background: rgba(255, 255, 255, 0.2);
        }
        .time-slot {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            text-align: center;
        }
        .time-slot:hover {
            background-color: #f8f9fa;
        }
        .time-slot.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .time-slot.disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        .barbero-card .btn-seleccionado {
            background-color: #007bff !important;
            color: white !important;
        }
        .servicio-card .btn-seleccionado {
            background-color: #28a745 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar d-md-block p-3">
                <div class="position-sticky pt-3">
                    <h4 class="text-white text-center mb-4">
                        <i class="bi bi-scissors"></i> BarberApp
                    </h4>
                    
                    <div class="text-center mb-4">
                        <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                             style="width: 80px; height: 80px;">
                            <i class="bi bi-person-fill text-primary" style="font-size: 2rem;"></i>
                        </div>
                        <h5 class="text-white mt-2" sec:authentication="name">Cliente</h5>
                        <span class="badge bg-light text-dark">CLIENTE</span>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/cliente/dashboard">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/citas/cliente">
                                <i class="bi bi-calendar-check"></i> Mis Citas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/citas/cliente/nueva">
                                <i class="bi bi-plus-circle"></i> Nueva Cita
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/cliente/perfil">
                                <i class="bi bi-person-circle"></i> Mi Perfil
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link text-warning" href="/auth/logout">
                                <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
                <!-- Navbar -->
                <nav class="navbar navbar-light bg-white border-bottom shadow-sm">
                    <div class="container-fluid">
                        <span class="navbar-brand fw-bold text-primary">
                            <i class="bi bi-plus-circle"></i> Agendar Nueva Cita
                        </span>
                        <a href="/citas/cliente" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    </div>
                </nav>
                
                <!-- Content -->
                <div class="container-fluid py-4">
                    <!-- Alertas -->
                    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <span th:text="${success}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    
                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <span th:text="${error}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    
                    <!-- Informaci√≥n de Cliente -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="bi bi-person-circle me-2"></i>Cliente Actual</h6>
                        <p class="mb-0">
                            <strong>Nombre:</strong> <span th:text="${cliente.nombre}">Cliente</span> | 
                            <strong>Email:</strong> <span th:text="${cliente.email}">email@ejemplo.com</span>
                        </p>
                    </div>
                    
                    <!-- Formulario -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-calendar-plus"></i> Detalles de la Cita
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form th:action="@{/citas/cliente/crear}" th:object="${citaRequest}" method="post" id="citaForm">
                                        
                                        <!-- Paso 1: Seleccionar Barbero -->
                                        <div class="mb-4">
                                            <h5 class="mb-3">1. Selecciona tu Barbero</h5>
                                            <div class="alert alert-warning">
                                                <small>
                                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                                    <strong>IMPORTANTE:</strong> Los barberos tienen IDs espec√≠ficos. 
                                                    IDs v√°lidos: <strong>5 (Carlos)</strong>, <strong>6 (Ana)</strong>, <strong>7 (Roberto)</strong>
                                                </small>
                                            </div>
                                            <div class="row">
                                                <!-- Barberos din√°micos con IDs CORRECTOS -->
                                                <div class="col-md-4 mb-3" th:each="empleado : ${empleados}">
                                                    <div class="card text-center barbero-card">
                                                        <div class="card-body">
                                                            <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center mb-3" 
                                                                 style="width: 80px; height: 80px;">
                                                                <i class="bi bi-person-fill text-white" style="font-size: 2rem;"></i>
                                                            </div>
                                                            <h6 th:text="${empleado.nombre}">Nombre</h6>
                                                            <p class="text-muted small">
                                                                Especialidad: <span th:text="${empleado.especialidad}"></span>
                                                            </p>
                                                            <p class="text-success">
                                                                <i class="bi bi-star-fill"></i> 
                                                                <span th:text="${empleado.calificacionPromedio}">4.8</span>/5.0
                                                            </p>
                                                            <p class="text-info small">
                                                                <strong>ID:</strong> <span th:text="${empleado.id}"></span>
                                                            </p>
                                                            <button type="button" 
                                                                    class="btn btn-outline-primary btn-sm btn-select-barbero"
                                                                    th:attr="data-barbero-id=${empleado.id}"
                                                                    th:text="'Seleccionar'">
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" th:field="*{empleadoId}" id="empleadoId">
                                            <div class="text-danger small" id="empleadoError"></div>
                                        </div>
                                        
                                        <!-- Paso 2: Seleccionar Servicio -->
                                        <div class="mb-4">
                                            <h5 class="mb-3">2. Selecciona un Servicio</h5>
                                            <div class="row">
                                                <!-- Servicios din√°micos -->
                                                <div class="col-md-6 mb-3" th:each="servicio : ${servicios}">
                                                    <div class="card servicio-card">
                                                        <div class="card-body">
                                                            <h6 th:text="${servicio.nombre}">Servicio</h6>
                                                            <p class="text-muted small" th:text="${servicio.descripcion}">
                                                                Descripci√≥n del servicio
                                                            </p>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="badge bg-secondary">
                                                                    <span th:text="${servicio.duracionMinutos}">30</span> min
                                                                </span>
                                                                <strong>
                                                                    $<span th:text="${#numbers.formatDecimal(servicio.precio, 1, 2)}">150.00</span>
                                                                </strong>
                                                            </div>
                                                            <p class="text-info small mt-2">
                                                                <strong>ID:</strong> <span th:text="${servicio.id}"></span>
                                                            </p>
                                                            <button type="button" 
                                                                    class="btn btn-outline-success btn-sm w-100 mt-2 btn-select-servicio"
                                                                    th:attr="data-servicio-id=${servicio.id}"
                                                                    th:text="'Seleccionar'">
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" th:field="*{servicioId}" id="servicioId">
                                            <div class="text-danger small" id="servicioError"></div>
                                        </div>
                                        
                                        <!-- Paso 3: Seleccionar Fecha y Hora -->
                                        <div class="mb-4">
                                            <h5 class="mb-3">3. Selecciona Fecha y Hora</h5>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Fecha</label>
                                                    <input type="date" class="form-control" id="fechaSeleccionada"
                                                           th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
                                                           min="2025-12-05">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Horarios Disponibles</label>
                                                    <div id="horariosContainer" class="d-flex flex-wrap">
                                                        <!-- Horarios est√°ticos para demo -->
                                                        <div class="time-slot" data-hora="09:00">09:00 AM</div>
                                                        <div class="time-slot" data-hora="09:30">09:30 AM</div>
                                                        <div class="time-slot" data-hora="10:00">10:00 AM</div>
                                                        <div class="time-slot" data-hora="10:30">10:30 AM</div>
                                                        <div class="time-slot" data-hora="11:00">11:00 AM</div>
                                                        <div class="time-slot" data-hora="11:30">11:30 AM</div>
                                                        <div class="time-slot" data-hora="14:00">02:00 PM</div>
                                                        <div class="time-slot" data-hora="14:30">02:30 PM</div>
                                                        <div class="time-slot" data-hora="15:00">03:00 PM</div>
                                                        <div class="time-slot" data-hora="15:30">03:30 PM</div>
                                                        <div class="time-slot" data-hora="16:00">04:00 PM</div>
                                                        <div class="time-slot" data-hora="16:30">04:30 PM</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" th:field="*{fechaHora}" id="fechaHora">
                                            <div class="text-danger small" id="fechaHoraError"></div>
                                        </div>
                                        
                                        <!-- Paso 4: Notas Adicionales -->
                                        <div class="mb-4">
                                            <h5 class="mb-3">4. Notas Adicionales (Opcional)</h5>
                                            <textarea class="form-control" th:field="*{notas}" 
                                                      rows="3" placeholder="Ej: Prefiero el corte corto por los lados, alergia a ciertos productos, etc."></textarea>
                                        </div>
                                        
                                        <!-- Botones -->
                                        <div class="d-flex justify-content-between">
                                            <a href="/citas/cliente" class="btn btn-secondary">
                                                <i class="bi bi-x-circle"></i> Cancelar
                                            </a>
                                            <button type="submit" class="btn btn-primary" id="btnAgendar">
                                                <i class="bi bi-calendar-check"></i> Agendar Cita
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen -->
                        <div class="col-lg-4">
                            <div class="card sticky-top" style="top: 20px;">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-receipt"></i> Resumen de la Cita
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="resumenCita">
                                        <p class="text-muted">Selecciona los detalles de tu cita para ver el resumen aqu√≠.</p>
                                    </div>
                                    
                                    <hr>
                                    
                                    <!-- Debug Info (solo para desarrollo) -->
                                    <div class="alert alert-dark small">
                                        <h6><i class="bi bi-bug"></i> Informaci√≥n para Debug</h6>
                                        <p class="mb-1"><strong>IDs V√°lidos de Barberos:</strong> 5, 6, 7</p>
                                        <p class="mb-1"><strong>IDs V√°lidos de Servicios:</strong> 1, 2, 3, 4, 5</p>
                                        <p class="mb-0"><strong>Cliente ID:</strong> <span th:text="${cliente.id}">?</span></p>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <h6><i class="bi bi-info-circle"></i> Informaci√≥n Importante</h6>
                                        <ul class="small mb-0">
                                            <li>Puedes cancelar hasta 2 horas antes</li>
                                            <li>Llega 10 minutos antes</li>
                                            <li>Trae tu comprobante de cita</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <h6><i class="bi bi-clock"></i> Horario de Atenci√≥n</h6>
                                        <p class="mb-0 small">
                                            Lunes a Viernes: 9:00 AM - 7:00 PM<br>
                                            S√°bados: 9:00 AM - 5:00 PM<br>
                                            Domingos: Cerrado
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script para manejar la selecci√≥n -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("=== üéØ NUEVA-CITA.JS INICIADO ===");
            console.log("üìã IDs v√°lidos de barberos: 5, 6, 7");
            
            let barberoSeleccionado = null;
            let servicioSeleccionado = null;
            let horaSeleccionada = null;
            
            // Seleccionar barbero
            document.querySelectorAll('.btn-select-barbero').forEach(btn => {
                btn.addEventListener('click', function() {
                    const barberoId = this.dataset.barberoId;
                    console.log(`üë®‚Äçüíº Barbero seleccionado: ID ${barberoId}`);
                    
                    // Remover selecci√≥n anterior
                    document.querySelectorAll('.btn-select-barbero').forEach(b => {
                        b.classList.remove('btn-primary', 'btn-seleccionado');
                        b.classList.add('btn-outline-primary');
                        b.textContent = 'Seleccionar';
                    });
                    
                    // Marcar como seleccionado
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary', 'btn-seleccionado');
                    this.textContent = '‚úì Seleccionado';
                    
                    // Actualizar valor del campo oculto
                    barberoSeleccionado = barberoId;
                    document.getElementById('empleadoId').value = barberoId;
                    document.getElementById('empleadoError').textContent = '';
                    
                    console.log(`‚úÖ Campo empleadoId actualizado: ${barberoId}`);
                    actualizarResumen();
                });
            });
            
            // Seleccionar servicio
            document.querySelectorAll('.btn-select-servicio').forEach(btn => {
                btn.addEventListener('click', function() {
                    const servicioId = this.dataset.servicioId;
                    console.log(`‚úÇÔ∏è  Servicio seleccionado: ID ${servicioId}`);
                    
                    // Remover selecci√≥n anterior
                    document.querySelectorAll('.btn-select-servicio').forEach(b => {
                        b.classList.remove('btn-success', 'btn-seleccionado');
                        b.classList.add('btn-outline-success');
                        b.textContent = 'Seleccionar';
                    });
                    
                    // Marcar como seleccionado
                    this.classList.remove('btn-outline-success');
                    this.classList.add('btn-success', 'btn-seleccionado');
                    this.textContent = '‚úì Seleccionado';
                    
                    // Actualizar valor del campo oculto
                    servicioSeleccionado = servicioId;
                    document.getElementById('servicioId').value = servicioId;
                    document.getElementById('servicioError').textContent = '';
                    
                    console.log(`‚úÖ Campo servicioId actualizado: ${servicioId}`);
                    actualizarResumen();
                });
            });
            
            // Seleccionar hora
            document.querySelectorAll('.time-slot:not(.disabled)').forEach(slot => {
                slot.addEventListener('click', function() {
                    const hora = this.dataset.hora;
                    console.log(`üïê Hora seleccionada: ${hora}`);
                    
                    // Remover selecci√≥n anterior
                    document.querySelectorAll('.time-slot').forEach(s => {
                        s.classList.remove('selected');
                    });
                    
                    // Marcar como seleccionado
                    this.classList.add('selected');
                    
                    // Actualizar valor del campo oculto
                    horaSeleccionada = hora;
                    const fecha = document.getElementById('fechaSeleccionada').value;
                    const fechaHora = fecha + 'T' + hora + ':00';
                    document.getElementById('fechaHora').value = fechaHora;
                    document.getElementById('fechaHoraError').textContent = '';
                    
                    console.log(`‚úÖ Campo fechaHora actualizado: ${fechaHora}`);
                    actualizarResumen();
                });
            });
            
            // Cambiar fecha
            document.getElementById('fechaSeleccionada').addEventListener('change', function() {
                console.log(`üìÖ Fecha cambiada: ${this.value}`);
                horaSeleccionada = null;
                document.querySelectorAll('.time-slot').forEach(s => {
                    s.classList.remove('selected');
                });
                document.getElementById('fechaHora').value = '';
                actualizarResumen();
            });
            
            // Validar formulario antes de enviar
            document.getElementById('citaForm').addEventListener('submit', function(e) {
                console.log("=== üìã VALIDANDO FORMULARIO ===");
                console.log(`Barbero ID: ${barberoSeleccionado}`);
                console.log(`Servicio ID: ${servicioSeleccionado}`);
                console.log(`Fecha/Hora: ${document.getElementById('fechaHora').value}`);
                
                let isValid = true;
                
                if (!barberoSeleccionado) {
                    document.getElementById('empleadoError').textContent = 'Selecciona un barbero';
                    console.error("‚ùå Falta seleccionar barbero");
                    isValid = false;
                } else {
                    // Validar que el ID del barbero sea v√°lido (5, 6, 7)
                    const idsValidos = ['5', '6', '7'];
                    if (!idsValidos.includes(barberoSeleccionado)) {
                        document.getElementById('empleadoError').textContent = 
                            `ID ${barberoSeleccionado} no v√°lido. IDs v√°lidos: 5, 6, 7`;
                        console.error(`‚ùå ID de barbero inv√°lido: ${barberoSeleccionado}`);
                        isValid = false;
                    }
                }
                
                if (!servicioSeleccionado) {
                    document.getElementById('servicioError').textContent = 'Selecciona un servicio';
                    console.error("‚ùå Falta seleccionar servicio");
                    isValid = false;
                }
                
                if (!horaSeleccionada) {
                    document.getElementById('fechaHoraError').textContent = 'Selecciona una hora';
                    console.error("‚ùå Falta seleccionar hora");
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Por favor completa todos los campos requeridos y aseg√∫rate de que los IDs sean correctos.');
                    console.error("‚ùå Formulario NO enviado - Faltan datos");
                } else {
                    console.log("‚úÖ Formulario validado correctamente");
                    console.log("üì§ Enviando formulario...");
                    // Mostrar datos que se enviar√°n
                    const formData = new FormData(this);
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}: ${value}`);
                    }
                }
            });
            
            // Actualizar resumen
            function actualizarResumen() {
                const resumenDiv = document.getElementById('resumenCita');
                let html = '';
                
                if (barberoSeleccionado || servicioSeleccionado || horaSeleccionada) {
                    html += '<h6>Detalles de tu cita:</h6><ul class="list-unstyled">';
                    
                    if (barberoSeleccionado) {
                        const barberoBtn = document.querySelector(`[data-barbero-id="${barberoSeleccionado}"]`);
                        if (barberoBtn) {
                            const barberoNombre = barberoBtn.closest('.card-body').querySelector('h6').textContent;
                            html += `<li><strong>Barbero:</strong> ${barberoNombre} (ID: ${barberoSeleccionado})</li>`;
                        }
                    }
                    
                    if (servicioSeleccionado) {
                        const servicioBtn = document.querySelector(`[data-servicio-id="${servicioSeleccionado}"]`);
                        if (servicioBtn) {
                            const servicioCard = servicioBtn.closest('.card-body');
                            const servicioNombre = servicioCard.querySelector('h6').textContent;
                            const servicioPrecio = servicioCard.querySelector('strong').textContent;
                            html += `<li><strong>Servicio:</strong> ${servicioNombre}</li>`;
                            html += `<li><strong>Precio:</strong> ${servicioPrecio}</li>`;
                        }
                    }
                    
                    if (horaSeleccionada) {
                        const fecha = document.getElementById('fechaSeleccionada').value;
                        const fechaFormateada = new Date(fecha).toLocaleDateString('es-ES', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        html += `<li><strong>Fecha:</strong> ${fechaFormateada}</li>`;
                        html += `<li><strong>Hora:</strong> ${horaSeleccionada}</li>`;
                    }
                    
                    html += '</ul>';
                    
                    if (barberoSeleccionado && servicioSeleccionado && horaSeleccionada) {
                        html += '<div class="alert alert-success mt-3">';
                        html += '<strong><i class="bi bi-check-circle"></i> ¬°Todo listo!</strong><br>';
                        html += 'Revisa que los IDs sean correctos:<br>';
                        html += `<small>Barbero ID: ${barberoSeleccionado} | Servicio ID: ${servicioSeleccionado}</small>`;
                        html += '</div>';
                    }
                } else {
                    html = '<p class="text-muted">Selecciona los detalles de tu cita para ver el resumen aqu√≠.</p>';
                }
                
                resumenDiv.innerHTML = html;
            }
            
            // Inicializar con fecha de hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaSeleccionada').value = today;
            console.log(`üìÖ Fecha inicializada: ${today}`);
        });
    </script>
</body>
</html>